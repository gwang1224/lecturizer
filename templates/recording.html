<!DOCTYPE html>
<html>
<head>
<title>W3.CSS Template</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
body,h1 {font-family: "Montserrat", sans-serif}
img {margin-bottom: -7px}
.w3-row-padding img {margin-bottom: 12px}
</style>
</head>
<body>

<!-- Sidebar -->
<nav class="w3-sidebar w3-black w3-animate-top w3-xxlarge" style="display:none;padding-top:150px" id="mySidebar">
  <a href="javascript:void(0)" onclick="w3_close()" class="w3-button w3-black w3-xxlarge w3-padding w3-display-topright" style="padding:6px 24px">
    <i class="fa fa-remove"></i>
  </a>
  <div class="w3-bar-block w3-center">
    <a href="#" class="w3-bar-item w3-button w3-text-grey w3-hover-black">About</a>
    <a href="#" class="w3-bar-item w3-button w3-text-grey w3-hover-black">Photos</a>
    <a href="#" class="w3-bar-item w3-button w3-text-grey w3-hover-black">Shop</a>
    <a href="#" class="w3-bar-item w3-button w3-text-grey w3-hover-black">Contact</a>
  </div>
</nav>

<!-- !PAGE CONTENT! -->
<div class="w3-content" style="max-width:1500px">

<!-- Header -->
<div class="w3-opacity">
<span class="w3-button w3-xxlarge w3-white w3-right" onclick="w3_open()"><i class="fa fa-bars"></i></span>
<div class="w3-clear"></div>
<header class="w3-center w3-margin-bottom">
  <h1><b>LECTURIZER</b></h1>
  <p><b>actually understand your lectures</b></p>

  <!-- Toggle Record Button -->
  <p class="w3-padding-16"><button style='border-radius: 25px;' class="w3-button w3-black" id="record">Start Recording ðŸ”´</button></p>
  <p class="w3-padding-16"><button style='border-radius: 25px;' class="w3-button w3-black" id="play">Play Audio Recording</button></p>

  <br>
  <form id="uploadForm" method="post" enctype="multipart/form-data">
    <input name="file" type="file" id="audioFile" required>
    <button type="submit" style='border-radius: 25px;' class="w3-button w3-black">Upload and Summarize</button>
  </form>
  <div id="output"> </div>
</header>
</div>

<!-- End Page Content -->
</div>

<script>
const recordButton = document.getElementById('record');
const playButton = document.getElementById('play');
let output = document.getElementById('output');
let audioRecorder;
let audioChunks = [];
let isRecording = false;

navigator.mediaDevices.getUserMedia({ audio: true })
  .then(stream => {
    // Initialize the media recorder object
    audioRecorder = new MediaRecorder(stream);

    // dataavailable event is fired when the recording is stopped
    audioRecorder.addEventListener('dataavailable', e => {
      audioChunks.push(e.data);
    });

    // Toggle recording when the record button is clicked
    recordButton.addEventListener('click', async () => {
    if (!isRecording) {
        // Start recording
        audioChunks = [];
        audioRecorder.start();
        isRecording = true;
        recordButton.textContent = 'Stop Recording';
        output.innerHTML = 'Recording started! Speak now.';
    } else {
        // Stop recording and send the audio file to the server
        audioRecorder.stop();
        isRecording = false;
        recordButton.textContent = 'Start Recording ðŸ”´';
        output.innerHTML = 'Recording stopped! Processing audio...';

        const blobObj = new Blob(audioChunks, { type: 'audio/webm' });
        const formData = new FormData();
        formData.append('file', blobObj, 'recording.webm');

        console.log("Sending audio to server...");

        try {
            const response = await fetch('/', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            console.log("Server response received:", data);
            if (data.summary) {
                output.innerHTML = `<p><b>Summary:</b> ${data.summary}</p>`;
            } else if (data.error) {
                output.innerHTML = `<p>Error: ${data.error}</p>`;
            }
        } catch (error) {
            console.error('Error:', error);
            output.innerHTML = '<p>An error occurred while processing the file.</p>';
        }
    }
});

    // Play the recorded audio when the play button is clicked
    playButton.addEventListener('click', () => {
      const blobObj = new Blob(audioChunks, { type: 'audio/webm' });
      const audioUrl = URL.createObjectURL(blobObj);
      const audio = new Audio(audioUrl);
      audio.play();
      output.innerHTML = 'Playing the recorded audio!';
    });
  }).catch(err => {
    // If the user denies permission to record audio, display an error
    console.log('Error: ' + err);
  });

document.getElementById('uploadForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const fileInput = document.getElementById('audioFile');
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);

    document.getElementById('output').innerHTML = '<p>Summarizing...</p>';

    try {
        const response = await fetch('/', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();
        if (data.summary) {
            document.getElementById('output').innerHTML = `<p style="padding: 0px 150px 0px 150px;"><b>Summary:</b> ${data.summary}</p>`;
        } else if (data.error) {
            document.getElementById('output').innerHTML = `<p>Error: ${data.error}</p>`;
        }
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('output').innerHTML = '<p>An error occurred while processing the file.</p>';
    }
});
</script>

</body>
</html>
